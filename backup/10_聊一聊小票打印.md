# [èŠä¸€èŠå°ç¥¨æ‰“å°](https://github.com/mengqiuleo/mengqiuleo.github.io/issues/10)

è¿™é‡Œæ¶‰åŠåˆ°çš„ä¸šåŠ¡æ˜¯ electron å®ç°å°ç¥¨æ‰“å°ã€‚



å°ç¥¨æ‰“å°çš„å®ç°æ–¹æ¡ˆä¸»è¦æœ‰ä¸¤ç§ï¼Œ

ç¬¬ä¸€ç§æ˜¯è°ƒç”¨ electron è‡ªå¸¦çš„ print æ–¹æ³•è¿›è¡Œæ‰“å°ï¼Œæ€è·¯ä¸æµè§ˆå™¨åŸç”Ÿ API æ‰“å°çš„å®ç°ç›¸åŒï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ–°çš„çª—å£ï¼Œåœ¨è¿™ä¸ªçª—å£ä¸­ç”»å‡ºè¦æ‰“å°çš„å†…å®¹ï¼Œç„¶åè°ƒç”¨ `printWindow.webContents.print` æ–¹æ³•æ‰“å°è¿™ä¸ªçª—å£çš„å†…å®¹ã€‚

ç¬¬äºŒç§æ˜¯è°ƒç”¨ ESC/POS æŒ‡ä»¤ï¼Œç›®å‰å¸‚é¢ä¸Šå¤§éƒ¨åˆ†æ‰“å°æœºå‡æ”¯æŒè¯¥æŒ‡ä»¤ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è¯¥æŒ‡ä»¤æ§åˆ¶æ‰“å°å†…å®¹åŠæ‰“å°æ ·å¼ã€‚ä¸” ESC/POS æŒ‡ä»¤åº”è¯¥æ˜¯å¤§éƒ¨åˆ†å°ç¥¨æ‰“å°çš„ä¸»æµå®ç°æ–¹å¼ï¼Œç¬¬ä¸€ç§æ–¹æ¡ˆè™½ç„¶ä¹Ÿå¯ä»¥å®ç°ï¼Œä½†æ‰“å°æ•ˆæœï¼ˆå­—ä½“æ¸…æ™°åº¦ï¼Œæ’ç‰ˆï¼‰å¹¶ä¸å¥½ï¼Œå¹¶ä¸”åœ¨æˆ‘è¿™è¾¹è¿˜å‡ºç°äº†ä¸Šä¸‹å·¦å³è¾¹è·åœ¨ä¸åŒçš„æ‰“å°æœºä¸Šä¸ä¸€è‡´çš„é—®é¢˜ã€‚





è¿™é‡Œä¸ä»‹ç»ç¬¬ä¸€ç§æ–¹æ¡ˆçš„å®ç°ï¼Œç½‘ä¸Šæ–‡ç« æ¯”è¾ƒå¤šï¼Œä¸ªäººæ„Ÿè§‰è¿™ç§å®ç°å¹¶ä¸å¤ªé è°±ï¼Œé™¤äº†ä¸Šé¢è¯´çš„æ ·å¼é—®é¢˜ï¼Œä¸ªäººæ„Ÿè§‰æœ€å¤§çš„å‘ç‚¹æ˜¯ï¼šä¸€äº›é…ç½®ä¸ç”Ÿæ•ˆï¼Œä»ç½‘ä¸Šç›´æ¥æ‹¿è¿‡æ¥çš„æ–¹æ¡ˆä¸èƒ½ç›´æ¥è¿è¡Œï¼Œæœ€åæ’æŸ¥æ˜¯æŸäº›å‚æ•°æ²¡æœ‰åŠ ï¼Œå¹¶ä¸”æˆ‘é…ç½®çš„ä¸€äº›å‚æ•°è²Œä¼¼ä¸ç”Ÿæ•ˆ or ä¸éœ€è¦ã€‚





å…³äº ESC/POS æŒ‡ä»¤çš„å®ç°ï¼Œè¿™é‡Œå…ˆæ¨èä¸€äº›å…³äºçƒ­æ•æ‰“å°æœºçš„çŸ¥è¯†åŠç›¸å…³å®ç°æ–¹æ¡ˆï¼š

1. [https://www.cnblogs.com/MrDing/category/627839.html](https://www.cnblogs.com/MrDing/category/627839.html)
2. [https://juejin.cn/post/7297529039312158730](https://juejin.cn/post/7297529039312158730)
3. [https://juejin.cn/post/6844903734573531150](https://juejin.cn/post/6844903734573531150)
4. [https://juejin.cn/post/6844903893873197064](https://juejin.cn/post/6844903893873197064)





ä¸ªäººæ„Ÿè§‰[ã€Šå¤èŒ—æ‰“å°æœºæŠ€æœ¯çš„æ¼”è¿›ã€‹](https://juejin.cn/post/7297529039312158730)è¿™ç¯‡æ–‡ç« å·²ç»å†™çš„å¾ˆå¥½äº†ï¼Œè¿™é‡Œä¸»è¦æ˜¯å¯¹è¯¥æ–‡ç« çš„è§£è¯»ä»¥åŠèŠä¸€ä¸‹å®è·µé‡åˆ°çš„é—®é¢˜ã€‚





## æ•´ä½“æ€è·¯

> <font style="color:rgb(0, 0, 0);">æ‰“å°æœºé©±åŠ¨çš„ä½œç”¨å…¶å®ç›¸å½“äºâ€œç¿»è¯‘â€ï¼Œç”µè„‘è¦æƒ³é€šè¿‡æ‰“å°æœºæ‰“å‡ºå›¾åƒå’Œæ–‡å­—ï¼Œä¸¤è€…ä¹‹é—´å°±å¿…é¡»ä½¿ç”¨ç»Ÿä¸€çš„â€œè¯­è¨€â€æ²Ÿé€šï¼Œæ‰“å°æœºé©±åŠ¨å°±æ˜¯å°†è®¡ç®—æœºæƒ³è¦è¯´çš„è¯æŒ‰ç…§çº¦å®šçš„æ ‡å‡†ï¼ˆä¾‹å¦‚ESC/POSæŒ‡ä»¤ï¼‰â€œç¿»è¯‘â€æˆæ‰“å°æœºèƒ½è¯†åˆ«çš„è¯­è¨€ã€‚</font>

<font style="color:rgb(0, 0, 0);">ä¸Šé¢æåˆ°çš„ electron æ–°å»ºçª—å£æ‰“å°ï¼Œå…¶å®å°±ç›¸å½“äºæˆ‘ä»¬å‘Šè¯‰æ‰“å°æœºé©±åŠ¨è¦æ‰“å°ä»€ä¹ˆä¸œè¥¿ï¼Œç„¶åæ‰“å°æœºé©±åŠ¨â€œç¿»è¯‘â€å¹¶å‘é€ç»™æ‰“å°æœºã€‚</font>

è€Œ ESC/POS æŒ‡ä»¤æ‰“å°ï¼Œç›¸å½“äºæˆ‘ä»¬ç›´æ¥å‘æ‰“å°æœºå‘é€ç¿»è¯‘åçš„å†…å®¹ã€‚



æ³¨ï¼šæˆ‘ä»¬è¿™é‡Œå…ˆè®¨è®º USB è¿æ¥çš„æ‰“å°æœºï¼Œä¸²å£æ‰“å°æœºã€å¹¶å£æ‰“å°æœºæ”¾åœ¨ç¬¬äºŒéƒ¨åˆ†ã€‚



**æ•´ä½“æ€è·¯**ï¼šæ•´ä½“åˆ†ä¸¤æ­¥èµ°ï¼Œç¬¬ä¸€æ­¥ï¼Œæˆ‘ä»¬å°†æ‰“å°çš„å†…å®¹ç¿»è¯‘ä¸º ESC/POS æŒ‡ä»¤ï¼Œç¬¬äºŒæ­¥ï¼Œæ‰¾åˆ°æ‰“å°æœºåœ¨å“ªä¸ª USB æ¥å£ï¼Œå¹¶å°†æ•°æ®ä¼ è¾“ç»™è¯¥ USB æ¥å£ã€‚





<h3 id="Yha1u">ESC/POS æŒ‡ä»¤å°è£…</h3>

è¿™ä¸ªç½‘ä¸Šæœ‰ç°æˆçš„åº“ï¼Œä½†æ˜¯æ ¹æ®ä¸šåŠ¡éœ€è¦ï¼Œè¿˜éœ€è¦è‡ªå®šä¹‰å°è£…ä¸€äº›æŒ‡ä»¤ï¼Œç´¢æ€§å°±è‡ªå·±å…¨å°è£…äº†ï¼ˆå…¶å®æ˜¯ç›´æ¥å¯¹åˆ«äººå°è£…å¥½çš„è¿›è¡ŒäºŒæ¬¡å°è£…ï¼ŒæŒ‡è·¯ï¼š[https://github.com/Freeman8612/escpos-printer](https://github.com/Freeman8612/escpos-printer)ï¼‰

<font style="color:rgb(0, 0, 0);"></font>

<font style="color:rgb(0, 0, 0);">æŒ‡ä»¤é›†å°è£…è¿‡ç¨‹ä¸­ï¼Œé‡åˆ°çš„ä¸€ä¸ªé—®é¢˜æ˜¯ã€Œå¯¹æ¡ç çš„å°è£…ã€</font>

<font style="color:rgb(0, 0, 0);">æ¡ç ç±»å‹å¾ˆå¤šï¼Œæ¯”å¦‚ CODE128ï¼ŒCODE39ï¼ŒEAN13...</font>

<font style="color:rgb(0, 0, 0);">æˆ‘è¿™é‡Œæ‰“å°çš„æ˜¯è‡ªå®šä¹‰çš„æ¡ç ï¼Œå‡ä¸ºæ•°å­—ï¼Œé•¿åº¦ä¸º 16ä½ã€‚æ‰€ä»¥å°±é€‰æ‹©äº† CODE128</font>

<font style="color:rgb(0, 0, 0);"></font>

<img width="894" height="921" alt="Image" src="https://github.com/user-attachments/assets/0a28feb3-2dca-449e-a7b1-7e22a51d2d8f" />



å‚è€ƒä¸Šå›¾çš„æŒ‡ä»¤è¯´æ˜ï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°ä»¥ä¸‹å°è£…æ–¹æ³•ï¼š

```javascript
/**
 * æ‰“å°è®¢å•å·æ¡ç ï¼ˆCODE128ï¼‰ 8,73 ä¸ºCODE128  4,69 ä¸ºCODE39
 *
 * @param {String} code è®¢å•å·ï¼Œå¦‚ "2025101900000016"
 * @return {Command}
 */
barcodeOrderNo(code) {
  code = String(code);
  console.log(code);
  this._queue.push(...this._cmd["ESA"], 1);

  // æ¡ç å®½åº¦ 1
  this._queue.push(0x1d, 0x77, 2);
  // æ¡ç é«˜åº¦ 60 dots
  this._queue.push(0x1d, 0x68, 70);

  this._queue.push(...this._cmd["GSH"], 2);
  // this._queue.push(...this._cmd["GSK"], 8, ...Command.transformNumberToBarcode(code), 0x00);
  this._queue.push(...this._cmd["GSK"], 73, code.length, ...code.split("").map(c => c.charCodeAt(0)));

  this._queue.push(...this._cmd["ESA"], 0);
  return this;
}
```

<font style="color:rgb(0, 0, 0);"></font>

**<font style="color:rgb(0, 0, 0);">é‡åˆ°çš„é—®é¢˜ï¼šæ¡ç æ•°å­—è¿‡é•¿ï¼Œå¯¼è‡´è¶…è¿‡äº†å°ç¥¨æœ‰é™å®½åº¦ï¼Œåˆ™æ‰“å°æœºæ‰“å°ä¸å‡ºæ¥ã€‚ï¼ˆå¯ä»¥è‡ªæµ‹æ‰“å° 123456789 å’Œ 2025101900000016 è¿›è¡Œå¯¹æ¯”ï¼‰</font>**

**<font style="color:rgb(0, 0, 0);"></font>**

<font style="color:rgb(0, 0, 0);">è§£å†³ï¼š</font>

<font style="color:rgb(0, 0, 0);">ä¸ç›´æ¥é€šè¿‡æŒ‡ä»¤æ‰“å°æ¡ç ï¼Œè€Œæ˜¯å…ˆå°†æ¡ç ç”Ÿæˆå›¾ç‰‡ï¼Œå¹¶è½¬åŒ–ä¸º base64 å†è¿›è¡Œæ‰“å°</font>

```javascript
const imgBuffer = Buffer.from(orderData.orderNoBase64.replace(/^data:image\/\w+;base64,/, ""), "base64");
await cmd.image(imgBuffer, "image/png") // æ‰“å°æ¡ç å›¾ç‰‡
```

```javascript
export function generateBarcodeBase64(orderNo: string) {
  const canvas = document.createElement("canvas");

  JsBarcode(canvas, orderNo, {
    format: "CODE128",   // æ¨è CODE128
    displayValue: true,  // æ˜¾ç¤ºä¸€ç»´ç ä¸‹æ–¹çš„æ–‡å­—
    fontSize: 26, // 16 26 è®¾ç½®æ¡å½¢ç æ–‡æœ¬çš„å­—ä½“å¤§å°
    height: 90, // 50  90 æŒ‡å®šæ¡å½¢ç é«˜åº¦
    width: 2, // æŒ‡å®šæ¡å½¢ç ä¸­å•æ¡ç«–çº¿çš„å®½åº¦
  });

  return canvas.toDataURL("image/png");
}
```

<font style="color:rgb(0, 0, 0);"></font>

<font style="color:rgb(0, 0, 0);"></font>

### å¯¹æŒ‡å®š USB å£è¿›è¡Œæ•°æ®ä¼ è¾“

<font style="color:rgb(0, 0, 0);">å‚è€ƒå¤èŒ—çš„å®ç°æ–¹æ¡ˆï¼š</font>

1. æ‰¾åˆ° USB è®¾å¤‡åˆ—è¡¨ï¼ˆè¿™é‡Œè°ƒç”¨ [node-escpos-win](https://www.npmjs.com/package/node-escpos-win)ï¼‰
2. è·å–æ‰“å°æœºé©±åŠ¨åˆ—è¡¨
3. è·å– USB çš„ã€Œç«¯å£:è·¯å¾„ã€æ˜ å°„
4. æ ¹æ®ç”¨æˆ·é€‰æ‹©çš„æ‰“å°æœºåç§°ï¼Œä»æ‰“å°æœºé©±åŠ¨åˆ—è¡¨ä¸­æ‹¿åˆ°å¯¹åº”çš„æ‰“å°æœºï¼Œç„¶åæ‰¾åˆ°è¯¥æ‰“å°æœºçš„ã€Œç«¯å£:è·¯å¾„ã€æ˜ å°„ï¼Œå†å°†è¯¥æ˜ å°„ä¸ USB è®¾å¤‡åˆ—è¡¨åŒ¹é…ï¼Œæ‰¾åˆ°æŒ‡å®šçš„ USB è®¾å¤‡è·¯å¾„
5. å‘è¯¥ USB è®¾å¤‡å‘é€ ESC/POS æŒ‡ä»¤





<h4 id="iK1jJ">æ‰¾åˆ° USB è®¾å¤‡åˆ—è¡¨</h4>

```javascript
import escpos from 'node-escpos-win';

const usb = escpos.GetDeviceList('USB');
const usbList = usb.list.filter(
  (item: any) => item.service === 'usbprint' || item.name === 'USB æ‰“å°æ”¯æŒ'
);
```



<font style="color:rgb(0, 0, 0);"></font>

<h4 id="i653R"><font style="color:rgb(0, 0, 0);">è·å–æ‰“å°æœºé©±åŠ¨åˆ—è¡¨</font></h4>

æ‰“å°æœºé©±åŠ¨ä¸­å¯ä»¥çœ‹åˆ°å½“å‰æ‰“å°æœºæ‰€åœ¨çš„ USB ç«¯å£ï¼Œå¦‚å›¾æ‰€ç¤ºï¼š  

![Image](https://github.com/user-attachments/assets/df3ed2b0-f8ea-4877-a867-25ccf7bfde5b)

å½“å‰æ‰“å°æœºæ‰€åœ¨ç«¯å£ä¸º USB001





è·å–æ‰“å°æœºé©±åŠ¨åˆ—è¡¨çš„å®ç°æ–¹å¼æœ‰å¤šç§ï¼Œå¤èŒ—é€‰æ‹©äº† `wmic-js`è¿™ä¸ª npm åŒ…ï¼Œä½†æ˜¯æˆ‘æœ¬åœ°æ‰§è¡Œæ—¶ç›´æ¥æŠ¥é”™ï¼Œæç¤ºå­—ç¬¦ç¼–ç ä¸åŒï¼Œäºæ˜¯æ¢æˆäº†ç”¨ `win32-printer`npm åŒ…æ¥è·å–ã€‚ä½†`win32-printer`åœ¨ CICD æ‰§è¡Œæ—¶æŠ¥é”™ï¼ˆäº‘ç«¯æ„å»ºé‡‡ç”¨çš„é•œåƒä¸º `electronuserland/builder:wine`ï¼‰ã€‚è¿™ä¸ªé—®é¢˜æ²¡æ·±ç©¶ï¼Œæ—¢ç„¶å¯ä»¥é€šè¿‡`wmic-js`npm åŒ…æ¥å®ç°ï¼Œé‚£ä¹ˆåŸç”Ÿçš„ wmic å‘½ä»¤ä¹Ÿæ˜¯å¯ä»¥çš„ã€‚

è¿™é‡ŒæŠŠä¸‰ç§å®ç°æ–¹å¼éƒ½åˆ—ä¸¾ä¸€ä¸‹ã€‚

**wmic-js**

```javascript
// è·å–æ‰“å°æœºé©±åŠ¨çš„ä¿¡æ¯
export const getPrinter = () => {
  const wmic = require('wmic-js');
  return new Promise<Printer[]>((res, rej) => {
    wmic()
      .alias('printer')
      .get('Name', 'printerState', 'printerStatus', 'WorkOffline', 'PortName')
      .then((data: Printer[]) => {
        res(data);
      })
      .catch((err: unknown) => {
        rej(err);
      });
  });
}
```



**win32-printer**

```javascript
export const getPrinters = (): Printer[] => {
  const printer = require('win32-printer');
  const printers = printer.getPrinters();

  return printers.map((p: any) => ({
    Name: p.name,
    PortName: p.portName,
    WorkOffline: p.attributes.offline,
    printerState: p.status,
    printerStatus: p.status,
  }));
};
```



**wmic å‘½ä»¤**

```javascript
export const getPrinterList = (): Promise<PrinterInfo[]> => {
  return new Promise((resolve, reject) => {
    const cmd = `wmic printer get Name,PortName,WorkOffline,PrinterStatus,PrinterState /format:list`;

    exec(cmd, { encoding: 'utf8' }, (err, stdout) => {
      if (err) return reject(err);

      // console.log('wmic printer stdout:', stdout);
      const printers: PrinterInfo[] = [];
      let current: Record<string, string> = {};

      stdout.split(/\r?\n/).forEach(line => {
        line = line.trim();
        if (!line) return; // è·³è¿‡ç©ºè¡Œ

        const [k, v] = line.split('=');
        if (!k) return;

        if (k === 'Name') {
          // é‡åˆ°æ–°çš„ Nameï¼Œå°±æŠŠä¸Šä¸€ä¸ª current ä¿å­˜
          if (current.Name) {
            printers.push({
              Name: current.Name,
              PortName: current.PortName,
              WorkOffline: current.WorkOffline,
              PrinterStatus: current.PrinterStatus,
              PrinterState: current.PrinterState
            });
            current = {};
          }
        }
        current[k.trim()] = (v ?? '').trim();
      });

      // æœ€åä¸€æ¡
      if (current.Name) {
        printers.push({
          Name: current.Name,
          PortName: current.PortName,
          WorkOffline: current.WorkOffline,
          PrinterStatus: current.PrinterStatus,
          PrinterState: current.PrinterState
        });
      }

      resolve(printers);
    });
  });
};

```



<h4 id="O0khl">è·å– USB çš„ã€Œç«¯å£:è·¯å¾„ã€æ˜ å°„</h4>

```typescript
export const printPortMap = () => {
  return new Promise<Record<string, string>>((res, rej) => {
    exec('wmic path Win32_USBControllerDevice get Dependent /format:list', (err, stdout) => {
      if (err) {
        rej(err);
        return;
      }
      const usbList: string[] = [];
      const map: Record<string, string> = {};
      const lines = stdout.split('\r\r\n');

      lines.forEach((line: any) => {
        if (line.startsWith('Dependent=')) {
          const usb = line.replace('Dependent=', '');
          usbList.push(usb);
        }
      });
      for (let i = 0; i < usbList.length; i++) {
        if (usbList[i].indexOf('USBPRINT') > -1) {
          const line = usbList[i].replace(/"/g, '');
          const portName = line.substr(line.length - 6);
          const usbPath = usbList[i - 1].replace(/&amp;/g, '&');
          if (portName.indexOf('USB') > -1) {

            console.log('usbPath', usbPath);
            // å°† DeviceID ä¸­çš„æ ¼å¼è½¬æ¢æˆ usbList é‡Œæ ¼å¼ï¼ˆéƒ½è½¬å°å†™åŒ¹é…ï¼‰
            const normalizedUsbPath = usbPath
              .toLowerCase()
              .replace(/\\/g, '#') // USB\VID_0483&PID_070B\4F3CC8100303 -> usb#vid_0483&pid_070b#4f3cc8100303
              .replace(/^usb#/, ''); // æœ‰çš„ usbList æ²¡æœ‰ usb# å¼€å¤´

            map[portName] = normalizedUsbPath;
          }
        }
      }
      res(map);
    });
  });
};
```







<h4 id="qzsjG">æ‰¾åˆ°æŒ‡å®šçš„ USB è®¾å¤‡è·¯å¾„</h4>

```typescript
function extractUsbId(str) {
  if (typeof str !== 'string') return null;
  const match = str.match(/usb#vid_[0-9a-f]+&pid_[0-9a-f]+#[^"#\\]+/i);
  return match ? match[0].toLowerCase() : null;
}
function isUsbDeviceMatch(devicePath, portMapString) { // è¿™é‡Œä¸»è¦åŒ¹é…çš„æ˜¯ pid å’Œ vid
  const idFromPath = extractUsbId(devicePath);
  const idFromPortMap = extractUsbId(portMapString);
  return idFromPath && idFromPortMap && idFromPath === idFromPortMap;
}

printList.forEach((printItem: any) => {
    if (printItem.Name === printerName) {
      const usbDevice = usbList.find((useItem: any) => {
        return isUsbDeviceMatch(useItem.path, portMap[printItem.PortName]);
      })

      const res = escpos.Print(usbDevice.path, buffer);
      // console.log('æ‰“å°ç»“æœ', res); // æ‰“å°ç»“æœ { success: 1, err: 0 }
      escpos.Disconnect(usbDevice.path);

      callback(res)
    }
  })
```




<font style="background-color:#FBDE28;">pid å’Œ vid:</font>

 åœ¨ USB è®¾å¤‡çš„ä¸Šä¸‹æ–‡ä¸­ï¼Œ  `PID` å’Œ `VID` ç”¨äºå”¯ä¸€è¯†åˆ«è®¾å¤‡  

VID: æ ‡è¯†è®¾å¤‡çš„**åˆ¶é€ å•†**æ˜¯è°ã€‚æ¯ä¸ªæ³¨å†Œå‚å•†ä¸€ä¸ªå”¯ä¸€çš„ VIDã€‚

+ **ä¾‹å¦‚ï¼š**
  - `0x046D` â†’ Logitechï¼ˆç½—æŠ€ï¼‰
  - `0x04E8` â†’ Samsungï¼ˆä¸‰æ˜Ÿï¼‰
  - `0x05AC` â†’ Appleï¼ˆè‹¹æœï¼‰
  - `0x2C7C` â†’ Quectelï¼ˆç§»è¿œé€šä¿¡ï¼‰

PID: æ ‡è¯†è¯¥å‚å•†æ——ä¸‹çš„**å…·ä½“äº§å“å‹å·**ã€‚ç”±å‚å•†è‡ªå·±å®šä¹‰ï¼ˆä¸å…¶ VID æ­é…ä½¿ç”¨ï¼‰ã€‚

+ **ä¾‹å¦‚ï¼š**
  - VID:PID = `046D:C52B` â†’ ç½—æŠ€æ— çº¿æ¥æ”¶å™¨
  - VID:PID = `05AC:12A8` â†’ iPhoneï¼ˆUSB è¿æ¥æ¨¡å¼ï¼‰
  - VID:PID = `2C7C:0125` â†’ Quectel EC25 4G æ¨¡å—









<h2 id="W0lgM">æ„å»ºéƒ¨ç½²ç»†èŠ‚</h2>
<h3 id="xkP38">æœ¬åœ°æ„å»º node-escpos-win is not a valid Win32 application</h3>

æœ¬åœ°æ‰§è¡Œæ²¡ä»€ä¹ˆé—®é¢˜ï¼Œéå¸¸ä¸æ»‘ã€‚ä½†æ˜¯é¦–æ¬¡å°è¯•æœ¬åœ°æ„å»ºä½¿ç”¨æŠ¥é”™äº†ï¼ˆå½“æ—¶æœ¬åœ°æ„å»ºçš„æ˜¯ 32 ä½çš„ exeï¼‰ï¼š

![Image](https://github.com/user-attachments/assets/6fae013e-0fba-4584-a774-bb194e3e9aa7)



ä»é”™è¯¯è¯­ä¹‰ä¸Šï¼Œè¯´æ˜ node-escpos-win ä¸æ˜¯ä¸€ä¸ª 32ä½çš„åŒ…ã€‚

æ’æŸ¥åŠè§£å†³ï¼š

1. æœ¬åœ°å®‰è£…ä¾èµ–æ—¶æ‰§è¡Œçš„æ˜¯`npm i node-escpos-win`ï¼Œç”±äºç”µè„‘æ˜¯ 64 ä½çš„ï¼Œé‚£ä¹ˆå®‰è£…çš„ä¾èµ–è‡ªç„¶æ˜¯ 32ä½çš„ã€‚
2. é‚£ä¹ˆè‡ªç„¶è€Œç„¶ï¼Œè§£å†³æ–¹æ¡ˆä¸ºæ„å»ºä¸€ä¸ª 32 ä½çš„åŒ…ï¼Œå‘½ä»¤å¦‚ä¸‹ï¼š

```typescript
- cd node_modules/node-escpos-win
- node-gyp clean configure build --target=31.7.7 --arch=ia32 --dist-url=https://electronjs.org/headers --verbose
- cd ../../
```

3. ç„¶åå†æ¬¡æ‰§è¡Œæœ¬åœ°æ„å»ºå‘½ä»¤ï¼Œæ‰“åŒ…åçš„ exe å¯æ­£å¸¸æ‰§è¡Œ
4. é‚£ä¹ˆäº‘ç«¯æ„å»ºè‡ªç„¶ä¹Ÿæ˜¯å°†è¿™äº›å‘½ä»¤åŠ å…¥è„šæœ¬å³å¯



ä½†ç»è¿‡ä¸€ç•ªæ“ä½œï¼Œäº‘ç«¯æ„å»ºç¡®å®æˆåŠŸäº†ï¼Œä½†æ˜¯å‘å¸ƒçš„ exe å´æ²¡æ³•ç”¨ï¼Œä¾ç„¶æŠ¥é”™ï¼š.node is not a valid Win32 application.

å¦å¤–è¿˜æœ‰ä¸€ä¸ªé—®é¢˜æ—¶ï¼Œåœ¨æˆ‘æœ¬åœ°æ‰“åŒ…åï¼Œæ­¤æ—¶æ‰§è¡Œ`npm run dev`ï¼Œä¹ŸæŠ¥é”™äº†ï¼Œä¾ç„¶æ˜¯ç›¸åŒçš„é”™è¯¯ï¼Œä½† `node-escpos-win`è¿™ä¸ªåŒ…å·²ç»æ˜¯ 32 ä½çš„å•Šã€‚



**é—®é¢˜å®šä½ï¼š**

**è¿™ä¸ªæŠ¥é”™æœ‰ç‚¹å…·æœ‰è¿·æƒ‘æ€§ï¼Œå½“ Electron å’Œ npm åŒ…æ¶æ„å¯¹ä¸ä¸Šæ—¶éƒ½ä¼šæŠ¥è¿™ä¸ªé”™ï¼Œä¸ä¸€å®šæ˜¯æŒ‡è¿™ä¸ª npm åŒ…ä¸æ˜¯ 32 ä½çš„ã€‚**

æˆ‘çš„ electron æ˜¯ 64 ä½çš„ã€‚å¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤æ£€æŸ¥ï¼š

```typescript
console.log("Electron process.arch =", process.arch); // Electron process.arch = x64
```



node-escpos-win è¿™ä¸ªåŒ…æ˜¯ 32 ä½çš„ã€‚å¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤æ£€æŸ¥ï¼š

```typescript
lenovo@LAPTOP-D59IOVE5 MINGW64 /e/pos (dev)
$ file node_modules/node-escpos-win/build/Release/*.node
node_modules/node-escpos-win/build/Release/addon.node: PE32 executable (DLL) (GUI) Intel 80386, for MS Windows, 5 sections
```



é‚£ä¹ˆæ­¤æ—¶çš„è§£å†³æ–¹æ¡ˆå°±å¾ˆæ¸…æ™°äº†ï¼š

1. æŠŠæœ¬åœ° electron  æ¶æ„æ¢æˆ 32 ä½çš„ï¼ˆå…¶å®ä¸å¤ªåˆé€‚...ï¼‰
2. æœ¬åœ°è£… node-escpos-win npm åŒ…æ—¶ï¼Œæœ¬åœ°å¼€å‘æ‰‹åŠ¨æ„å»ºä¸º 64 ä½ï¼Œæœ¬åœ°æ„å»ºè‡ªæµ‹æ—¶æ‰‹åŠ¨æ„å»ºä¸º 32 ä½ï¼Œä¸‹æ¬¡æœ¬åœ°å¼€å‘ä¹‹å‰åˆæ‰‹åŠ¨æ„å»ºæˆ 64 ä½çš„ï¼ˆè¿™ä¸ªæ–¹æ¡ˆéå¸¸ä¸åˆé€‚...ï¼‰





äº‘ç«¯æ„å»ºæŠ¥é”™çš„åŸå› ï¼ˆäº‘ç«¯é•œåƒä¸º`electronuserland/builder:wine`ï¼‰ï¼š

å°†æ„å»ºçš„ asar åç¼–è¯‘ï¼Œå¯¹è¯¥`.node`ä¾èµ–æ£€æµ‹æ˜¯å¦ä¸º 32 ä½çš„åŒ…ã€‚

```typescript
lenovo@LAPTOP-D59IOVE5 MINGW64 /d/exe/resources/unpacked_app
$ file node_modules/node-escpos-win/build/Release/*.node
node_modules/node-escpos-win/build/Release/addon.node: ELF 32-bit LSB shared object, Intel 80386, version 1 (SYSV), dynamically linked, BuildID[sha1]=f8b227b2a45bfa6372468de5816bc2fe9fbfad6c, not stripped
```

`.node` æ–‡ä»¶ **æ˜¯ Linux çš„ ELF æ ¼å¼**ï¼Œè€Œä¸æ˜¯ Windows çš„ PEï¼ˆPortable Executableï¼‰æ ¼å¼





æ—¢ç„¶äº‘ç«¯æ„å»ºä¸è¡Œï¼Œæœ¬åœ°ä¹Ÿè¦å¤šæ¬¡æ„å»ºï¼Œé‚£ä¹ˆä¸ºä»€ä¹ˆä¸ç»•è¿‡`node-escpos-win npm åŒ…`ï¼Œæˆ‘æœ¬åœ°å¯¹æºæ–‡ä»¶ç¼–è¯‘å¾—åˆ° `.node`ä¾èµ–ï¼Œç„¶åé¡¹ç›®ä¸­å¼•å…¥è¯¥ `.node`ä¾èµ–å‘¢ï¼Ÿ

è¿™ç§æ–¹æ¡ˆçš„ç¼ºç‚¹å°±æ˜¯å½“æœ¬åœ° electron çš„ç‰ˆæœ¬å˜æ›´åï¼Œéœ€è¦æ ¹æ®æ–°çš„ electron ç‰ˆæœ¬è¿›è¡Œé‡æ–°æ„å»ºå’Œå¼•å…¥ã€‚





æœ¬æ¥æƒ³çš„æ˜¯è‡ªå·±æ ¹æ® node-escpos-win çš„æºç ï¼Œè‡ªå·±ç¿»è¯‘æˆ rust ç‰ˆæœ¬ï¼Œç„¶ååˆ©ç”¨ naip-rs ç”Ÿæˆ .node ä¾èµ–ã€‚ä½†è¿™ç§æ–¹æ³•æ˜¾ç„¶ä¸æ˜¯æœ€ä¼˜è§£ã€‚æœ€åæŸ¥æ‰¾åˆ°ã€Œæˆ‘ä»¬ç”¨ npm åŒ…ä¸‹è½½çš„ä¾èµ–ï¼Œä¹Ÿæ˜¯å¯ä»¥ç”¨ node-gyp è¿›è¡ŒäºŒæ¬¡ç¼–è¯‘çš„ã€



<h3 id="jidKu">å¼•å…¥åŸç”Ÿ  .node ä¾èµ–</h3>

åœ¨`node_modules/node-escpos-win`ç›®å½•ä¸‹åˆ†åˆ«æ‰§è¡Œæ„å»ºå‘½ä»¤ï¼š

```typescript
node-gyp clean configure build --target=31.7.7 --arch=ia32 --dist-url=https://electronjs.org/headers --verbose
node-gyp clean configure build --target=31.7.7 --arch=x64 --dist-url=https://electronjs.org/headers --verbose
```

æŸ¥çœ‹`node_modules/node-escpos-win/build/Release`ç›®å½•ï¼Œå¯ä»¥åˆ†åˆ«å¾—åˆ° 32ä½ å’Œ 64ä½çš„ `.node`





**é¡¹ç›®ä¸­å¼•å…¥**

```typescript
import fs from 'fs';
import path from 'path';
import { createRequire } from 'module';
import { fileURLToPath } from 'url';

const requireCjs = createRequire(import.meta.url);
// ESM ä¸­è·å– __dirname
const __dirname = path.dirname(fileURLToPath(import.meta.url));

export function loadEscpos() {
  if (process.platform !== 'win32') {
    throw new Error(`Unsupported platform: ${process.platform}`);
  }

  let archFolder;
  switch (process.arch) {
    case 'ia32':
      archFolder = 'win32-ia32';
      break;
    case 'x64':
      archFolder = 'win32-x64';
      break;
    default:
      throw new Error(`Unsupported architecture: ${process.arch}`);
  }

  const addonPath = path.join(__dirname, '../../', 'native', 'node-escpos-win', archFolder, 'addon.node');

  if (!fs.existsSync(addonPath)) {
    throw new Error(`Native module not found: ${addonPath}`);
  }

  console.log(`Loading escpos native module: ${addonPath}`);
  return requireCjs(addonPath);
}

// ä½¿ç”¨
// import { loadEscpos } from './load-escpos-win.mjs';
// const escpos = loadEscpos();
```



åŸç”Ÿä¾èµ–å­˜æ”¾ä½ç½®ï¼šé¡¹ç›®æ ¹ç›®å½•ä¸‹`native/node-escpos-win/win32-ia32/addon.node`å’Œ`native/node-escpos-win/win32-x64/addon.node`



æ³¨æ„ï¼ŒåŸç”Ÿä¾èµ–ä¸åº”è¯¥æ‰“åŒ…è¿› asarï¼Œéœ€è¦å¯¹é…ç½®æ–‡ä»¶åšå¤„ç†ï¼š

```typescript
asarUnpack:
  - resources/**
  - native/**/*
```


<br /><br />



è‡³æ­¤ï¼Œescpos æŒ‡ä»¤çš„æ‰“å°åŠæ„å»ºå°±ç»“æŸäº†ã€‚å¯èƒ½è¿˜æœ‰æ‹“å±•çš„åœ°æ–¹æ˜¯å¯¹å°ç¥¨æ¨¡æ¿çš„ç¼–è¾‘ï¼Œè¿™ä¸ªæœ‰ç‚¹ç±»ä¼¼äºä½ä»£ç ï¼Œè®¾è®¡ä¸€å¥— DSL å°±è¡Œã€‚



## å¹¶å£æ‰“å°æœºæ‰“å°
å¹¶å£æ‰“å°æœºï¼Œå®ç°ä¸Šå…¶å®å°±æ˜¯æˆ‘ä»¬ç›´æ¥å‘æŒ‡å®šå¹¶å£ä¼ é€æ¶ˆæ¯ã€‚
ä¸€å°ç”µè„‘çš„ LPT æ¥å£ä¸€èˆ¬ä¸º 1~3 ä¸ªã€‚

<br/>
æŸ¥çœ‹æœ¬åœ°ç»‘å®šçš„å¹¶å£æ‰“å°æœºï¼š

```bash

C:\Windows\system32>wmic printer where "PortName like 'LPT%'" get Name,PortName
Name   PortName
POS58  LPT1:
```



å¦‚ä½•æŸ¥çœ‹æœ¬åœ°çš„å¹¶å£ç«¯å£ï¼Œä»¥åŠå½“å‰æ‰“å°æœºç»‘å®šçš„å¹¶å£å·ã€‚
**æŸ¥çœ‹æœ¬åœ°æ‰“å°æœº**ï¼šæ§åˆ¶é¢æ¿ -> æ‰“å°æœº -> æ‰“å°æœºå±æ€§ -> ç«¯å£

![Image](https://github.com/user-attachments/assets/b911f5c2-3503-4bcf-955c-0f926d33aa19)

**æŸ¥çœ‹æœ¬åœ°å¹¶å£**ï¼šæ§åˆ¶é¢æ¿ -> ç®¡ç†å·¥å…· -> ç³»ç»Ÿä¿¡æ¯ -> ç»„ä»¶ ç«¯å£ å¹¶å£
å‚è€ƒæ–‡ç« ï¼šhttps://jingyan.baidu.com/article/dca1fa6fadf31fb0a5405238.html

![Image](https://github.com/user-attachments/assets/f716ee09-6a3d-4e67-b041-730711d78e55)


æœ€ç®€å•çš„å‘æŒ‡å®š LPT ç«¯å£å‘é€æ‰“å°æ•°æ®ï¼š
```bash
echo test > LPT1
```


### ä»£ç å®ç°ï¼š
è¿™é‡Œç½‘ä¸Š JavaScript è¯­è¨€å®ç°çš„æ¡ˆä¾‹ä¸å¤šï¼Œè¿™é‡Œæˆ‘å‚è€ƒ C# çš„å®ç°ï¼Œè®© AI ç”Ÿäº§äº†ä¸€ç‰ˆã€‚

æ ¸å¿ƒåŸç†æ˜¯è°ƒç”¨ Windows çš„ APIï¼š
1. æ‰¾åˆ°å¥æŸ„
2. å†™å…¥æ•°æ®
3. å…³é—­å¥æŸ„

```js
const CreateFile = kernel32.func('CreateFileA', 'int32', [
  'str',       // lpFileName (string)
  'uint32',    // dwDesiredAccess (uint)
  'int32',     // dwShareMode (int)
  'int32',     // lpSecurityAttributes (int)
  'int32',     // dwCreationDisposition (int)
  'int32',     // dwFlagsAndAttributes (int)
  'int32'      // hTemplateFile (int)
]);

const WriteFile = kernel32.func('WriteFile', 'bool', [
  'void*',    // hFile
  'void*',    // lpBuffer
  'uint32',   // nNumberOfBytesToWrite
  'void*',    // lpNumberOfBytesWritten
  'void*',    // lpOverlapped
])


const CloseHandle = kernel32.func('CloseHandle', 'bool', [
  'void*'    // hObject
]);

// è·å–é”™è¯¯ä»£ç çš„å‡½æ•°
const GetLastError = kernel32.func('GetLastError', 'uint32', []);

export function printToLPT1() {
  console.log('å¼€å§‹ LPT1 æ‰“å°æµ‹è¯•...');

  let handle = null;

  try {
    handle = CreateFile(
      "\\\\.\\LPT1",       // ç«¯å£å
      0x40000000,   // GENERIC_WRITE | æ ‡å‡†æƒé™
      0,            // ç‹¬å è®¿é—®
      0,         // é»˜è®¤å®‰å…¨
      3,            // OPEN_EXISTING
      0,            // æ— ç‰¹æ®Šå±æ€§
      0          // æ— æ¨¡æ¿
    );

    if (!handle) {
      console.error('âŒ CreateFile è¿”å›äº†ç©ºå¥æŸ„');
    }


    // æ£€æŸ¥å¥æŸ„æ˜¯å¦æœ‰æ•ˆ
    if (handle == -1) {
      console.error('âŒ æ— æ³•æ‰“å¼€ LPT1 ç«¯å£');
      
      const errorCode = GetLastError();
      // å¸¸è§é”™è¯¯ä»£ç è§£é‡Š
      switch (errorCode) {
        case 2:
          console.error('é”™è¯¯: æ–‡ä»¶æœªæ‰¾åˆ° - æ£€æŸ¥ LPT1 æ˜ å°„');
          logger.log('é”™è¯¯: æ–‡ä»¶æœªæ‰¾åˆ° - æ£€æŸ¥ LPT1 æ˜ å°„');
          break;
        case 5:
          console.error('é”™è¯¯: è®¿é—®è¢«æ‹’ç» - éœ€è¦ç®¡ç†å‘˜æƒé™');
          logger.log('é”™è¯¯: è®¿é—®è¢«æ‹’ç» - éœ€è¦ç®¡ç†å‘˜æƒé™');
          break;
        case 6:
          console.error('é”™è¯¯: å¥æŸ„æ— æ•ˆ');
          logger.log('é”™è¯¯: å¥æŸ„æ— æ•ˆ');
          break;
        case 32:
          console.error('é”™è¯¯: æ–‡ä»¶æ­£åœ¨è¢«å…¶ä»–è¿›ç¨‹ä½¿ç”¨');
          logger.log('é”™è¯¯: æ–‡ä»¶æ­£åœ¨è¢«å…¶ä»–è¿›ç¨‹ä½¿ç”¨');
          break;
        default:
          console.error(`æœªçŸ¥é”™è¯¯ä»£ç : ${errorCode}`);
          logger.log(`æœªçŸ¥é”™è¯¯ä»£ç : ${errorCode}`);
      }
      return false;
    }


    console.log('âœ… LPT1 ç«¯å£æ‰“å¼€æˆåŠŸ');

    // å‡†å¤‡æ‰“å°æ•°æ®
    const printText = 'Hello from LPT1!\nThis is a test print.\n\n';
    const buffer = Buffer.from(printText, 'utf8');
    console.log(`å‡†å¤‡å†™å…¥ ${buffer.length} å­—èŠ‚æ•°æ®`);

    // åˆ†é…å†™å…¥å­—èŠ‚æ•°å˜é‡
    const writtenPtr = koffi.alloc('uint32', 1);

    // å†™å…¥æ•°æ®
    const success = WriteFile(
      handle,
      buffer,
      buffer.length,
      writtenPtr,
      null
    );

    if (success) {
      const bytesWritten = koffi.decode(writtenPtr, 'uint32');
      console.log(`âœ… å†™å…¥æˆåŠŸ: ${bytesWritten} å­—èŠ‚`);
    } else {
      console.error(`âŒ å†™å…¥å¤±è´¥ï¼Œé”™è¯¯ä»£ç : ${errorCode}`);
    }

    koffi.free(writtenPtr);
    return success;

  } catch (error) {
    console.error('æ‰“å°è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯:', error);
    return false;
  } finally {
    // å…³é—­å¥æŸ„
    if (handle && handle != -1) {
      CloseHandle(handle);
      console.log('ğŸ”’ LPT1 å¥æŸ„å·²å…³é—­');
    }
  }
}

// æ‰§è¡Œæ‰“å°
const result = printToLPT1();
console.log('æœ€ç»ˆç»“æœ:', result ? 'æˆåŠŸ' : 'å¤±è´¥');
```



API è§£è¯»ï¼š
- è¯»ï¼šhttps://learn.microsoft.com/en-us/windows/win32/api/fileapi/nf-fileapi-createfilew
- å†™ï¼šhttps://learn.microsoft.com/en-us/windows/win32/api/fileapi/nf-fileapi-writefile


**å…³äºæµ‹è¯•å¹¶å£æ‰“å°æœº**
æˆ‘è¿™è¾¹å½“æ—¶åªæœ‰ USB æ‰“å°æœºï¼Œæœ¬æ¥æƒ³ç€æŠŠ USB ç«¯å£æ˜ å°„åˆ° LPT ç«¯å£è¿›è¡Œæ‰“å°ï¼Œä½†æ˜¯æ‰“å°æœºä»…æ”¯æŒæœ¬åœ° PLT ç«¯å£æ‰“å°ï¼ˆè¿™é‡Œè®°å½•ä¸€ä¸‹æœ¬åœ°ç«¯å£æ˜ å°„çš„æ–¹æ³•ï¼‰ã€‚
å‚è€ƒæ–‡ç« ï¼šhttps://blog.51cto.com/jerkou/1351551

é¦–å…ˆæœç´¢ã€Œç®¡ç†é«˜çº§å…±äº«è®¾ç½®ã€ï¼Œå¯ç”¨"æ–‡ä»¶å’Œæ‰“å°æœºå…±äº«"
å…±äº«æ‚¨çš„æ‰“å°æœº
- æ‰“å¼€æ§åˆ¶é¢æ¿ > è®¾å¤‡å’Œæ‰“å°æœº
- å³é”®ç‚¹å‡»æ‚¨çš„ "Xprinter XP-58" æ‰“å°æœº
- é€‰æ‹©æ‰“å°æœºå±æ€§ > å…±äº«
- å‹¾é€‰"å…±äº«è¿™å°æ‰“å°æœº"ï¼Œå…±äº«åå¯ä»¥ä¿æŒé»˜è®¤æˆ–è‡ªå®šä¹‰

``` bash
# ä½¿ç”¨è®¡ç®—æœºåè€Œä¸æ˜¯ 127.0.0.1
NET USE LPT1: "\\%COMPUTERNAME%\Xprinter XP-58" /PERSISTENT:YES
```


ç®¡ç†æ˜ å°„çš„å‘½ä»¤
```
# æŸ¥çœ‹æ‰€æœ‰æ˜ å°„
NET USE

# åˆ é™¤ LPT1 æ˜ å°„
NET USE LPT1: /DELETE

# åˆ é™¤æ‰€æœ‰æ˜ å°„
NET USE * /DELETE
```